<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Display buildings in 3D with Mapbox Directions and Toggle Layers</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
<link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.1.0/mapbox-gl-directions.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
.toggle { position: absolute; top: 10px; left: 10px; background-color: #fff; padding: 10px; z-index: 1; }
</style>
</head>
<body>
<div id="map"></div>
<div class="toggle">
  <button id="bmtc" onclick="toggleLayer('bmtc')">BMTC</button>
  <button id="bmrcl" onclick="toggleLayer('bmrcl')">BMRCL</button>
</div>
<script>
mapboxgl.accessToken = 'pk.eyJ1IjoicG9vcm5pLWJhZHJpbmF0aCIsImEiOiJjanUwbmYzc3UwdDI3NGRtZ3kzMTltbWZpIn0.SB9PEksVcEwWvZJ9A7J9uA';
const map = new mapboxgl.Map({
    // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
    style: 'mapbox://styles/poorni-badrinath/clkkdd0eq00fd01qy03s15boh',
    center: [77.6106894, 12.9736492],
    zoom: 15.5,
    pitch: 45,
    bearing: -17.6,
    container: 'map',
    antialias: true
});

map.on('load', () => {
    // Add the Mapbox Directions control
    const directions = new MapboxDirections({
        accessToken: mapboxgl.accessToken
    });

    map.addControl(directions, 'top-right');
});

function toggleLayer(layer) {
    const bmtcButton = document.getElementById('bmtc');
    const bmrclButton = document.getElementById('bmrcl');

    if (layer === 'bmtc') {
        bmtcButton.classList.add('active');
        bmrclButton.classList.remove('active');
        map.setLayoutProperty('bmrcl-routes', 'visibility', 'none');
        map.setLayoutProperty('bmtc-routes', 'visibility', 'visible');
        map.setPaintProperty('bmtc-routes', 'line-opacity', 1); // Reset opacity to 1 for clicked bus route
        map.setPaintProperty('bmrcl-routes', 'line-opacity', 0.3); // Set opacity to 0.3 for other bus routes
    } else if (layer === 'bmrcl') {
        bmtcButton.classList.remove('active');
        bmrclButton.classList.add('active');
        map.setLayoutProperty('bmtc-routes', 'visibility', 'none');
        map.setLayoutProperty('bmrcl-routes', 'visibility', 'visible');
        map.setPaintProperty('bmrcl-routes', 'line-opacity', 1); // Reset opacity to 1 for clicked bus route
        map.setPaintProperty('bmtc-routes', 'line-opacity', 0.3); // Set opacity to 0.3 for other bus routes
    }
}

map.on('click', 'bmtc-routes', (e) => {
    const feature = e.features[0];
    const routeName = feature.properties.name;

    // Highlight the entire bus route with the same name in blue when clicked
    map.setFilter('bmtc-routes', ['==', 'name', routeName]);
    map.setPaintProperty('bmtc-routes', 'line-color', '#0000ff'); // Change color to blue

    // Reduce the opacity of other bus routes while keeping them visible
    map.setPaintProperty('bmrcl-routes', 'line-opacity', ['case', ['==', ['get', 'name'], routeName], 1, 0.3]);

    const coordinates = e.lngLat;

    // Show the label for the clicked feature
    new mapboxgl.Popup()
        .setLngLat(coordinates)
        .setHTML('<h3>' + feature.properties.name + '</h3>')
        .addTo(map);
});

map.on('click', 'bmrcl-routes', (e) => {
    const feature = e.features[0];
    const routeName = feature.properties.name;

    // Highlight the entire bus route with the same name in blue when clicked
    map.setFilter('bmrcl-routes', ['==', 'name', routeName]);
    map.setPaintProperty('bmrcl-routes', 'line-color', '#0000ff'); // Change color to blue

    // Reduce the opacity of other bus routes while keeping them visible
    map.setPaintProperty('bmtc-routes', 'line-opacity', ['case', ['==', ['get', 'name'], routeName], 1, 0.3]);

    const coordinates = e.lngLat;

    // Show the label for the clicked feature
    new mapboxgl.Popup()
        .setLngLat(coordinates)
        .setHTML('<h3>' + feature.properties.name + '</h3>')
        .addTo(map);
});

map.on('load', () => {
    // Add Tilesets as sources
    map.addSource('bmtc-routes', {
        type: 'vector',
        url: 'mapbox://poorni-badrinath.93qsbzov'
    });

    map.addSource('bmrcl-routes', {
        type: 'vector',
        url: 'mapbox://poorni-badrinath.aeg4rvqo'
    });

    // Add layers for each source
    map.addLayer({
        id: 'bmtc-routes',
        type: 'line',
        source: 'bmtc-routes',
        'source-layer': 'BMTCroutes-8tv4zo',
        paint: {
            'line-color': '#AF4D98', // Default color
            'line-width': 3,
            'line-opacity': 1 // Default opacity
        },
        layout: {
            'line-join': 'round',
            'line-cap': 'round'
        },
        visibility: 'visible'
    });

    map.addLayer({
        id: 'bmrcl-routes',
        type: 'line',
        source: 'bmrcl-routes',
        'source-layer': 'brmclcurrent-8resyf',
        paint: {
            'line-color': '#FFA62B', // Default color
            'line-width': 3,
            'line-opacity': 1 // Default opacity
        },
        layout: {
            'line-join': 'round',
            'line-cap': 'round'
        },
        visibility: 'visible'
    });

    // The 'building' layer in the Mapbox Streets
    // vector tileset contains building height data
    // from OpenStreetMap.
    map.addLayer(
        {
            'id': 'add-3d-buildings',
            'source': 'composite',
            'source-layer': 'building',
            'filter': ['==', 'extrude', 'true'],
            'type': 'fill-extrusion',
            'minzoom': 15,
            'paint': {
                'fill-extrusion-color': '#E8DDE8',
                'fill-extrusion-height': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    15,
                    0,
                    15.05,
                    ['get', 'height']
                ],
                'fill-extrusion-base': [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                     15,
                    0,
                    15.05,
                    ['get', 'min_height']
                ],
                'fill-extrusion-opacity': 0
            }
        }
    );
});
</script>
</body>
</html>
